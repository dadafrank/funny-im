<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
    <link rel="stylesheet" href="./index.css" />
  </head>
  <script src="./vue.js"></script>
  <script src="./emoji.js"></script>
  <body>
    <div id="app">
      <div class="content-container">
        <div
          class="msg-container"
          @click.stop="handleClickEmojiLeader(false)"
        >
          <div
            v-for="(msgItem, index) in msg"
            :key="index"
            :class="typeClassObj[msgItem.msg_type]"
          >
            <div
              :class="isConnectState(msgItem.msg_type) ? 'connected-content' : 'msg-content'"
              :data-nickname="msgItem.user || ''"
              :style="{ margin: msgItem.user ? '30px 0' : '10px 0' }"
            >
              {{msgItem.message}}
            </div>
          </div>
        </div>
        <!-- å‘é€çš„input -->
        <div class="input-container">
          <input v-model="inputVal" class="msg-input" @keyPress="inputMethod" @focus="inputFocus"/>
          <div @click.stop="handleClickEmojiLeader" class="emoji-button">ğŸ˜¬</div>
          <div disabled="!inputVal" class="msg-send-button" @click.stop="handleClickButton">å‘é€</div>
        </div>
        <!-- è¡¨æƒ…åŒ…åŒºåŸŸ -->
        <div v-show="emojiBoardVisible" class="emoji-container">
          <div
            v-for="(emoji, index) in emojiList"
            :key="index"
            :class="emoji ? 'emoji-item' : 'white-emoji-item'"
            @click.stop="handleClickEmoji(emoji)"
          >{{emoji}}</div>
        </div>
      </div>
    </div>
  </body>
  <script>
    const vm = new Vue({
      el: '#app',
      data: {
        socketItem: null, // å½“å‰çš„socket
        inputVal: '', // å½“å‰çš„è¾“å…¥å€¼
        typeClassObj: {
          send: 'send-msg-container',
          get: 'get-msg-container',
          login: 'connected-msg-container',
          leave: 'connected-msg-container',
          onlineCount: 'connected-msg-container',
          '': ''
        },
        connectStateObj: ['login', 'leave', 'onlineCount'], // æ˜¯å¦åªæ˜¯ç™»é™†ç­‰çš„çŠ¶æ€ï¼Œä¸æ˜¯æ¶ˆæ¯ä½“
        msg: [], // å·²å‘é€çš„æ¶ˆæ¯
        nickname: '', // è‡ªå·±çš„æ˜µç§°
        emojiBoardVisible: false,
        emojiList: [] // å­˜emojiè¡¨æƒ…
      },
      mounted () {
        // å°†emojiæå–
        this.emojiList = window.emojiList
        // åˆ›å»ºwebsocket
        const ws = new WebSocket("ws://172.20.10.2:9001")
        // è¿æ¥websocket
        ws.onopen = () => {
          this.socketItem  = ws
          this.msg.push({
            msg_type: 'login',
            message: 'å·²è¿›å…¥èŠå¤©å®¤'
          })
        }
        // å½“æ¥å—æ¶ˆæ¯æ—¶
        ws.onmessage = (msg) => {
          const data = JSON.parse(msg.data)
          if (data.msg_type === 'userInfo') {
            this.nickname = data.nickname
            this.msg.push({
              msg_type: 'onlineCount',
              message: 'å½“å‰' + data.onlineCount + 'ä½ç”¨æˆ·åœ¨çº¿'
            })
          } else {
            this.msg.push({
              msg_type: 'get',
              ...data
            })
          }

          // éœ€è¦æ»šåŠ¨åˆ°æœ€åº•ä¸‹
          this.screenToEnd()
        }
        // æ–­å¼€è¿æ¥
        ws.onclose = () => {
          if (socketItem) {
            this.socketItem = null
            this.msg.push({
              msg_type: 'login',
              message: 'æœåŠ¡å™¨æš‚åœæœåŠ¡'
            })
          }
        }
        // ç›‘å¬æ–­å¼€è¿æ¥
        window.onbeforeunload = function (e) {
          if (this.socketItem) {
            this.socketItem.close()
          }
        }
      },
      methods: {
        isConnectState (str) {
          if (this.connectStateObj.find(key => key === str)) {
            return true
          } else {
            return false
          }
        },
        sendMsg () {
          if (this.socketItem) {
            // è®°å½•å‘é€å€¼
            this.msg.push({
              msg_type: 'send',
              message: this.inputVal
            })
            // å‘é€è¯·æ±‚
            this.socketItem.send(JSON.stringify(this.inputVal))
            // æ¸…ç©ºæ¶ˆæ¯
            this.inputVal = ''
            // éœ€è¦æ»šåŠ¨åˆ°æœ€åº•ä¸‹
            this.screenToEnd()
          } else {
            alert('æš‚æœªè¿æ¥èŠå¤©å®¤')
          }
        },
        handleClickButton () {
          if (this.inputVal) {
            this.sendMsg()
          }
        },
        screenToEnd () {
          setTimeout(() => {
            const dom = document.querySelector('.msg-container')
            dom.scrollTop = dom.scrollHeight
          }, 0)
        },
        inputMethod (e) {
          // if (e.keyCode == 13 && e.shiftKey) {
          //   console.log('?????')
          //   this.inputVal += '\n'
          // } else if (e.keyCode === 13 && !e.shiftKey) {
          //   this.sendMsg()
          // }
          // æš‚æ—¶è¿™ä¹ˆå†™
          if (e.keyCode === 13 && !e.shiftKey) {
            this.sendMsg()
          }
        },
        inputFocus () {
          this.handleClickEmojiLeader(false)
        },
        // ç‚¹å‡»å‘é€æ—è¾¹çš„emiji
        handleClickEmojiLeader (state) {
          if (typeof state === 'boolean') {
            this.emojiBoardVisible = state
          } else {
            this.emojiBoardVisible = !this.emojiBoardVisible
          }
        },
        // ç‚¹å‡»äº†æŸä¸ªemoji
        handleClickEmoji (emoji) {
          if (emoji) {
            this.inputVal += emoji
          }
        }
      },
      watch: {
        inputVal: function() {
          this.inputVal = this.inputVal.trim()
        }
      }
    })
  </script>
</html>